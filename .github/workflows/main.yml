name: Sync IPTV Playlists

on:
  schedule:
    - cron: '0 */2 * * *'        # æ¯ 2 å°æ—¶è§¦å‘ï¼ˆUTCï¼‰
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download and Update IPTV Playlists
        run: |
          set -e
          echo "ğŸµ å¼€å§‹ä¸‹è½½ IPTV æ’­æ”¾åˆ—è¡¨..."
          
          # åˆ›å»ºç›®æ ‡ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          TARGET_DIR="fty/lib"
          OUTPUT_FILE="mursor.m3u"  # è‡ªå®šä¹‰è¾“å‡ºæ–‡ä»¶å
          mkdir -p "$TARGET_DIR"
          echo "ğŸ“ ç›®æ ‡æ–‡ä»¶: $TARGET_DIR/$OUTPUT_FILE"

          base="https://sub.ottiptv.cc"
          source_files=("iptv.m3u")  # æºæ–‡ä»¶åˆ—è¡¨

          # ---- å¸¦é‡è¯•æœºåˆ¶çš„ä¸‹è½½å‡½æ•° ----
          download_with_retry () {
            local url="$1"
            local outfile="$2"
            local tmpfile="${outfile}.tmp"   # ä¸´æ—¶æ–‡ä»¶
            local attempt=1
            local max=5

            rm -f "$tmpfile"                 # ä¿è¯å¹²å‡€èµ·æ­¥
            while [ $attempt -le $max ]; do
              echo "â¡ï¸  [$attempt/$max] ä¸‹è½½ $outfile ..."
              if wget -q --timeout=15 --connect-timeout=10 "$url" -O "$tmpfile"; then
                if [ -s "$tmpfile" ]; then   # æœ‰å†…å®¹æ‰ç®—æˆåŠŸ
                  mv "$tmpfile" "$outfile"
                  echo "âœ… $outfile ä¸‹è½½å¹¶è¦†ç›–å®Œæˆ"
                  return 0
                fi
              fi
              echo "âš ï¸  $outfile ä¸‹è½½å¤±è´¥ï¼Œç­‰å¾… $attempt ç§’åé‡è¯•..."
              sleep $attempt
              attempt=$(( attempt + 1 ))
            done

            echo "âŒ $outfile æœ€ç»ˆä¸‹è½½å¤±è´¥ï¼Œä¿ç•™æ—§ç‰ˆæœ¬"
            rm -f "$tmpfile"                 # ä¸åŠ¨æ—§æ–‡ä»¶
            return 1
          }

          # ä¸‹è½½æ‰€æœ‰æ–‡ä»¶åˆ°ç›®æ ‡ç›®å½•ï¼ˆä½¿ç”¨è‡ªå®šä¹‰æ–‡ä»¶åï¼‰
          for f in "${source_files[@]}"; do
            download_with_retry "${base}/${f}" "${TARGET_DIR}/${OUTPUT_FILE}" || true
          done

          echo "ğŸ“Š æ–‡ä»¶ä¸‹è½½çŠ¶æ€ï¼š"
          file_path="${TARGET_DIR}/${OUTPUT_FILE}"
          if [ -s "$file_path" ]; then
            echo "âœ… $file_path - $(wc -c < "$file_path") å­—èŠ‚"
          else
            echo "âŒ $file_path - æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©º"
          done

          git config --local user.name  "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"

          # åªæœ‰çœŸæ­£å‘ç”Ÿå˜æ›´æ—¶æ‰æäº¤
          if git diff --quiet -- "$file_path"; then
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi

          git add "$file_path"
          git commit -m "chore: auto-update IPTV playlists - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "âœ… æ–‡ä»¶å·²æäº¤"

      - name: Push changes
        env:
          GITHUB_TOKEN: ${{ secrets.APT }}
        run: |
          git push origin ${{ github.ref_name }}
          echo "ğŸš€ æ›´æ–°å·²æ¨é€åˆ°ä»“åº“"