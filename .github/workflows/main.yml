name: Sync IPTV Playlists

on:
  schedule:
    - cron: '0 */2 * * *'        # 每 2 小时触发（UTC）
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download and Update IPTV Playlists
        run: |
          set -e
          echo "🎵 开始下载 IPTV 播放列表..."
          
          # 创建目标目录（如果不存在）
          TARGET_DIR="fty/lib"
          OUTPUT_FILE="mursor.m3u"  # 自定义输出文件名
          mkdir -p "$TARGET_DIR"
          echo "📁 目标文件: $TARGET_DIR/$OUTPUT_FILE"

          base="https://sub.ottiptv.cc"
          source_files=("iptv.m3u")  # 源文件列表

          # ---- 带重试机制的下载函数 ----
          download_with_retry () {
            local url="$1"
            local outfile="$2"
            local tmpfile="${outfile}.tmp"   # 临时文件
            local attempt=1
            local max=5

            rm -f "$tmpfile"                 # 保证干净起步
            while [ $attempt -le $max ]; do
              echo "➡️  [$attempt/$max] 下载 $outfile ..."
              if wget -q --timeout=15 --connect-timeout=10 "$url" -O "$tmpfile"; then
                if [ -s "$tmpfile" ]; then   # 有内容才算成功
                  mv "$tmpfile" "$outfile"
                  echo "✅ $outfile 下载并覆盖完成"
                  return 0
                fi
              fi
              echo "⚠️  $outfile 下载失败，等待 $attempt 秒后重试..."
              sleep $attempt
              attempt=$(( attempt + 1 ))
            done

            echo "❌ $outfile 最终下载失败，保留旧版本"
            rm -f "$tmpfile"                 # 不动旧文件
            return 1
          }

          # 下载所有文件到目标目录（使用自定义文件名）
          for f in "${source_files[@]}"; do
            download_with_retry "${base}/${f}" "${TARGET_DIR}/${OUTPUT_FILE}" || true
          done

          echo "📊 文件下载状态："
          file_path="${TARGET_DIR}/${OUTPUT_FILE}"
          if [ -s "$file_path" ]; then
            echo "✅ $file_path - $(wc -c < "$file_path") 字节"
          else
            echo "❌ $file_path - 文件不存在或为空"
          done

          git config --local user.name  "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"

          # 只有真正发生变更时才提交
          if git diff --quiet -- "$file_path"; then
            echo "ℹ️ 没有检测到文件变更，跳过提交"
            exit 0
          fi

          git add "$file_path"
          git commit -m "chore: auto-update IPTV playlists - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "✅ 文件已提交"

      - name: Push changes
        env:
          GITHUB_TOKEN: ${{ secrets.APT }}
        run: |
          git push origin ${{ github.ref_name }}
          echo "🚀 更新已推送到仓库"